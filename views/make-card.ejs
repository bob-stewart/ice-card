<%
  function capitalize(word) {
    return word[0].toUpperCase() + word.substr(1);
  }
%>
<!DOCTYPE html>
<html>
  <head>
    <% title = 'Make an ICE card' %>
    <% include head.ejs %>
    <script>
      function clearGroup(group) {
        let all = document.getElementsByClassName(group);
        for (let i=0; i<all.length; i++) {
          all[i].value = '';
        };
      }
      function check(group) {
        let req = {};
        $('.' + group).each(function(i) {
          // entry-name
          let field = $(this).attr('name').split('-')[1];
          req[field] = $(this).val();
        });
        let closest = $.ajax({
          type: 'POST',
          data: req,
          url: '/closest-person.json',
        }).done(function(data) {
          console.log(data);
        });
      }
      var checkTimeoutId;
      function checkTimeout(e) {
        var nonTypeTime = 1000;
        clearTimeout(checkTimeoutId);
        // We set class to the group name so we can do this
        // TODO: Don't bank on this
        let group = e.target.className;
        checkTimeoutId = setTimeout(function() {
          check(group);
        }, nonTypeTime);
      }
      function init() {
        $('input').on('input', checkTimeout);
      }
      $(init);
    </script>
  </head>
  <body>
    <h1>Make an ICE card</h1>
    <p>Fill out as much as you want</p>
    <p>Your data will be safe on the blockchain</p>
    <div class="card">
      <form action="" method="post">
        <%
          // YPACE
          var names = ["you",
              "primary",
              "alternative",
              "contingency",
              "emergency",
          ];
          names.forEach(function(name) {
        %>
          <h2><%- capitalize(name) %></h2>
          <%
            var fields = [
              "name",
              "email",
              "phone",
              "address",
              "key",
            ];
            fields.forEach((field) => {
              var value = "";
              if (existing[name] && existing[name][field]) {
                value = existing[name][field];
              }
          %>
            <input
              <% if (field == "key") { %>
                type="hidden"
              <% } else { %>
                type="text"
              <% } %>
              placeholder="<%- capitalize(field) %>"
              name="<%- name %>-<%- field %>"
              class="<%- name %>" <%# Used for clearGroup and more %>
              value="<%= value %>"
            />
          <% }); %>
          <a href="javascript:void(0);" onclick="clearGroup('<%- name %>');" class="clear-group">
            Clear
          </a>
        <% }); %>
        <hr />
        <input type="submit" value="Print it" />
      </form>
    </div>
  </body>
</html>

